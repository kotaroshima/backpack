(function(){var c,q,r,k,l,m,n,f={}.hasOwnProperty;c=this.Backpack={};c.attach=function(){var a,b,d,c,e;c=arguments[0];d=arguments[1];switch(arguments.length){case 3:a=arguments[2];break;case 4:b=arguments[2],a=_.isString(arguments[3])?b[arguments[3]]:arguments[3]}e=c[d];c[d]=function(){var d;d=e.apply(c,arguments);b||(b=this);a&&a.apply(b,arguments);return d};return{detach:function(){c[d]=e}}};c.defaultPlugins=[];k=function(a,b){var d,g,e;null==b&&(b={});a.plugins=b.plugins||a.plugins;e=_.clone(c.defaultPlugins).concat(a.plugins||
[]);a.setups=[];a.cleanups=[];g={};_.each(e,function(b){var d,c;for(d in b)f.call(b,d)&&(c=b[d],"setup"!==d&&("cleanup"!==d&&"staticProps"!==d)&&(g[d]=c));b.setup&&a.setups.push(b.setup);b.cleanup&&a.cleanups.push(b.cleanup)});for(d in g)f.call(g,d)&&(e=g[d],a[d]||(a[d]=e));for(d in b)f.call(b,d)&&(e=b[d],"plugins"!==d&&"initialize"!==d&&(a[d]=e))};n=function(a){_.each(a.setups,function(b){b.apply(a)})};l=function(a){_.each(a.cleanups,function(b){b.apply(a)})};m=function(a,b){var d,c;d=Backbone.Model.extend.call(this,
a,b);a&&(c=a.plugins)&&(d.prototype.plugins=c,_.each(c,function(a){a.staticProps&&_.extend(d,a.staticProps)}));d.prototype.plugins||(d.prototype.plugins=[]);return d};q=c.Class=function(){this.cid=_.uniqueId("obj");this.initialize.apply(this,arguments)};_.extend(q.prototype,Backbone.Events,{initialize:function(){var a;a=0<arguments.length?arguments[arguments.length-1]:{};k(this,a);n(this);null!=a&&a.initialize&&a.initialize.apply(this,arguments)},destroy:function(){l(this)}});q.extend=m;c.Model=Backbone.Model.extend({initialize:function(a,
b){k(this,b);n(this);null!=b&&b.initialize&&b.initialize.apply(this,arguments)},destroy:function(a){l(this);Backbone.Model.prototype.destroy.apply(this,arguments)}});c.Model.extend=m;c.Collection=Backbone.Collection.extend({initialize:function(a,b){k(this,b);n(this);null!=b&&b.initialize&&b.initialize.apply(this,arguments)},destroy:function(){l(this)}});c.Collection.extend=m;c.View=Backbone.View.extend({initialize:function(a){k(this,a);n(this);null!=a&&a.initialize&&a.initialize.apply(this,arguments)},
delegateEvents:function(a){var b,d,c,e,h,p=this;if(!a&&!(a=_.result(this,"events")))return this;this.undelegateEvents();b=function(a){return _.bind(function(b){return p[a](b)},p)};for(c in a)if(f.call(a,c)&&(h=a[c],this[h]&&_.isFunction(this[h])))if(e=c.match(/^(\S+)\s*(.*)$/),d=e[1],e=e[2],h=b(h),d+=".delegateEvents"+this.cid,""===e)this.$el.on(d,h);else this.$el.on(d,e,h);return this},remove:function(){l(this);Backbone.View.prototype.remove.apply(this,arguments)},destroy:function(){this.remove()}});
c.View.extend=m;c.AttachPlugin={setup:function(){this._attached=[]},attach:function(){var a;switch(arguments.length){case 2:a=c.attach(this,arguments[0],arguments[1]);break;case 3:a=c.attach(arguments[0],arguments[1],arguments[2])}this._attached.push(a);return a},detach:function(a){var b,d;b=_.indexOf(this._attached,a);d=!1;-1!==b&&(this._attached.splice(b,1),a.detach(),d=!0);return d},cleanup:function(){_.invoke(this._attached,"detach");this._attached=[]}};c.defaultPlugins.push(c.AttachPlugin);c.ContainerPlugin=
{setup:function(){var a=this;this.containerNode||(this.containerNode=this.$el);this.children?_.each(this.children,function(b){a.addView(b)}):this.children=[]},getChild:function(a){if(a&&a.cid)return _.find(this.children,function(b){return b===a});if(_.isNumber(a))return this.children[a];if(_.isString(a))return _.find(this.children,function(b){return b.name===a})},addView:function(a){this.containerNode.append(a.$el)},addChild:function(a){this.addView(a);this.children.push(a)},removeChild:function(a){var b;
b=_.isNumber(a)?a:_.indexOf(this.children,a);0<=b&&(a=this.children[b],a.remove(),this.children.splice(b,1),this.onChildRemoved(a))},onChildRemoved:function(a){},clearChildren:function(){var a,b;for(a=b=this.children.length-1;0<=b;a=b+=-1)this.removeChild(a)},filterChildren:function(a){_.filter(this.children,function(b){b.model.filter(a)?b.$el.show():b.$el.hide()})},cleanup:function(){this.clearChildren()}};c.PublishPlugin={setup:function(){var a,b,d;this._publishers=[];if(this.publishers)for(a in d=
this.publishers,d)f.call(d,a)&&(b=d[a],this.addPublisher(a,b))},addPublisher:function(a,b){var d;d=c.attach(this,a,function(){var a;a=[].slice.call(arguments,0);a.unshift(b);Backbone.trigger.apply(Backbone,a)});this._publishers.push({handler:d,method:a,topic:b});return d},removePublisher:function(){var a,b,d,c,e;a=-1;e=this._publishers;for(b=c=e.length-1;0<=c;b=c+=-1)if(d=e[b],1<arguments.length&&_.isString(arguments[0])){if(arguments[0]===d.method&&arguments[1]===d.topic){a=b;break}}else if(arguments[0]===
d.handler){a=b;break}return 0<=a?(this._publishers[a].handler.detach(),this._publishers.splice(a,1),!0):!1},cleanup:function(){_.each(this._publishers,function(a){a.handler.detach()});this._publishers=[]}};c.defaultPlugins.push(c.PublishPlugin);c.Singleton={setup:function(){var a=this;if(_.find(c._singletons,function(b){return b.constructor===a.constructor}))throw Error("Only single instance can be initialized");c._singletons||(c._singletons=[]);c._singletons.push(this)},staticProps:{getInstance:function(){var a,
b=this;(a=_.find(c._singletons,function(a){return a.constructor===b}))||(a=new this);return a}}};c.SortablePlugin={setup:function(){!1!==this.sortable&&this.setSortable(!0)},_getSortableContainer:function(){return this.containerNode||this.$el},setSortable:function(a){var b,d=this;b=this._getSortableContainer();a?this._sortableInit?b.sortable("enable"):(a={start:function(a,b){b.item.startIndex=b.item.index()},stop:function(a,b){var c,p,f,k;c=d.collection;p=c.at(b.item.startIndex);k=b.item.index();
f=c.models;f.splice(b.item.startIndex,1);f.splice(k,0,p);c.reset(f);a.stopPropagation()}},this.sortableOptions&&(a=_.extend(a,this.sortableOptions)),b.sortable(a),this._sortableInit=!0):this._sortableInit&&b.sortable("disable")},cleanup:function(){this._sortableInit&&this._getSortableContainer().sortable("destroy")}};c.SubscribePlugin={setup:function(){var a,b,c;this._subscribers=[];if(this.subscribers)for(a in c=this.subscribers,c)f.call(c,a)&&(b=c[a],this.addSubscriber(a,b))},addSubscriber:function(a,
b){_.isString(b)&&(b=this[b]);this._subscribers.push({topic:a,callback:b});return Backbone.on(a,b,this)},removeSubscriber:function(a,b){var c,g,e,h,f;_.isString(b)&&(b=this[b]);c=-1;f=this._subscribers;for(g=h=f.length-1;0<=h;g=h+=-1)if(e=f[g],a===e.topic&&b===e.callback){c=g;break}return 0<=c?(-1!==c&&this._subscribers.splice(c,1),Backbone.off(a,b,this),!0):!1},cleanup:function(){var a=this;_.each(this._subscribers,function(b){return Backbone.off(b.topic,b.callback,a)});this._subscribers=[]}};c.defaultPlugins.push(c.SubscribePlugin);
c.StackView=c.View.extend({plugins:[c.ContainerPlugin],effects:{HIDE_BACKWARD:["slide",{direction:"right"},"slow"],HIDE_FORWARD:["slide",{direction:"left"},"slow"],SHOW_BACKWARD:["slide",{direction:"left"},"slow"],SHOW_FORWARD:["slide",{direction:"right"},"slow"]},initialize:function(a){var b;null==a&&(a={});c.View.prototype.initialize.apply(this,arguments);this.$el.css({position:"relative",width:"100%"});b=a.showIndex||0;this.children&&(0<=b&&b<this.children.length)&&(this._previousView=this._currentView=
this.children[b]);this.render()},render:function(){var a=this;_.each(this.children,function(b){b===a._currentView?b.$el.show():b.$el.hide()});return this},addView:function(a){var b,d=this;a.$el.css({position:"absolute",width:"99%"});c.ContainerPlugin.addView.apply(this,arguments);if(b=this.navigationEvents)if(b=b[a.name])b=_.isArray(b)?b:[b],_.each(b,function(b){d.attachNavigationEvent(a,b)})},attachNavigationEvent:function(a,b){var c,g=this;!0===b.back?a.attach(a,b.event,function(){g.onBack()}):
b.target&&(c=_.find(this.children,function(a){return a.name===b.target}),a.attach(a,b.event,function(){g.showChild(c)}))},onBack:function(){this.showPreviousChild()},showChild:function(a){var b;a=this.getChild(a);b=_.indexOf(this.children,a)<_.indexOf(this.children,this._currentView);this._currentView&&this._currentView.$el.hide.apply(this._currentView.$el,this.effects[b?"HIDE_BACKWARD":"HIDE_FORWARD"]);a.$el.show.apply(a.$el,this.effects[b?"SHOW_BACKWARD":"SHOW_FORWARD"]);this._previousView=this._currentView;
this._currentView=a},showPreviousChild:function(){this._previousView&&this.showChild(this._previousView)}});c.ListView=c.View.extend({plugins:[c.ContainerPlugin],template:_.template('<div class="main-node"><div class="containerNode"></div><div class="noItemsNode">No Items</div></div><div class="loadingNode">Loading...</div>',this.messages),itemView:c.View,itemOptions:{},initialize:function(a){a.itemView&&(this.itemView=a.itemView);this.$el.html(this.template);this.containerNode=this.$(".containerNode");
this._noItemsNode=this.$(".noItemsNode");this._mainNode=this.$(".main-node");this._loadingNode=this.$(".loadingNode");this.setLoading(!1);c.View.prototype.initialize.apply(this,arguments);this.collection.on("add reset",this.render,this);this.collection.on("remove",this.onRemoveModel,this);this.render()},render:function(){var a=this;this._toggleContainerNode();this.clearChildren();_.each(this.collection.models,function(b){b=a.createChild(b);a.addChild(b)});return this},_toggleContainerNode:function(){0<
this.collection.models.length?(this._noItemsNode.hide(),this.containerNode.show()):(this._noItemsNode.show(),this.containerNode.hide())},createChild:function(a){var b;b=_.clone(this.itemOptions);b=_.extend(b,{model:a});a=new this.itemView(_.extend(b,{model:a}));a.$el.addClass("item-view");return a.render()},onRemoveModel:function(a){var b,c,g,e,f=this;c=this.children;for(g=e=c.length-1;0<=e;g=e+=-1)if(b=c[g],b.model===a){b.$el.hide("slide",{direction:"left"},"fast",function(){f.removeChild(b);f._toggleContainerNode()});
break}},setLoading:function(a){a?(this._loadingNode.show(),this._mainNode.hide()):(this._loadingNode.hide(),this._mainNode.show())},remove:function(){this.collection.off("add reset",this.render);this.collection.off("remove",this.onRemoveModel);c.View.prototype.remove.call(this)}});r=c.View.extend({template:'<div class="item-view"><span class="delete-cell"><button class="delete-icon"></button></span><span class="editable-container"></span><span class="item-actions"><span class="reorder-handle"></span><button class="delete-button">Delete</button></span></div>',
events:{"click .delete-icon":"onRemoveConfirmButtonClicked","click .delete-button":"onRemoveButtonClicked"},initialize:function(a){this.itemView=a.itemView;this.itemOptions=a.itemOptions;this.render()},render:function(){var a;this.$el.html(this.template);a=_.clone(this.itemOptions);a=_.extend(a,{model:this.model});a=new this.itemView(a);a.render();this.$(".editable-container").append(a.$el);return this},onRemoveConfirmButtonClicked:function(a){var b;b=this.$el.hasClass("remove-confirm");this.$el.toggleClass("remove-confirm",
!b);a.stopPropagation()},onRemoveButtonClicked:function(a){this.model.destroy();a.stopPropagation()}});c.EditableListView=c.ListView.extend({plugins:[c.ContainerPlugin,c.SortablePlugin],sortableOptions:{handle:".reorder-handle"},initialize:function(a){c.ListView.prototype.initialize.apply(this,arguments);this.setEditable(!0===a.editable||!1)},setEditable:function(a){this.setSortable(a);this.$el.toggleClass("listview-edit",a)},createChild:function(a){return(new r({model:a,itemView:this.itemView,itemOptions:this.itemOptions})).render()}});
c.GoogleMapView=c.View.extend({apiKey:"",defaultLocation:{lat:-34.397,lng:150.644},subscribers:{GOOGLE_MAP_SCRIPT_LOADED:"_onScriptLoaded"},initialize:function(a){c.View.prototype.initialize.apply(this,arguments);a.el||this.$el.css({width:"100%",height:"100%"})},initMap:function(){var a;if(!this.apiKey||0===this.apiKey.length)throw Error("You need Google Map API key to use this widget");this._mapInit||(a=document.createElement("script"),a.type="text/javascript",a.src="http://maps.googleapis.com/maps/api/js?sensor=true&callback=Backpack.GoogleMapView.onScriptLoaded&key="+
this.apiKey,document.body.appendChild(a),this._mapInit=!0)},_onScriptLoaded:function(){this.map=new google.maps.Map(this.$el.get(0),{zoom:8,center:new google.maps.LatLng(this.defaultLocation.lat,this.defaultLocation.lng),mapTypeId:google.maps.MapTypeId.ROADMAP});this.removeSubscriber("GOOGLE_MAP_SCRIPT_LOADED",this._onScriptLoaded)},setLocation:function(a){this.map.panTo(new google.maps.LatLng(a.lat,a.lng))},addMarker:function(a){(new google.maps.Marker({position:new google.maps.LatLng(a.lat,a.lng),
title:a.title})).setMap(this.map)}});c.GoogleMapView.onScriptLoaded=function(){Backbone.trigger("GOOGLE_MAP_SCRIPT_LOADED")}}).call(this);
