(function(){var d,q,r,l,m,n,p,h={}.hasOwnProperty;d=this.Backpack={};d.attach=function(){var a,b,c,d,e;d=arguments[0];c=arguments[1];switch(arguments.length){case 3:a=arguments[2];break;case 4:b=arguments[2],a=_.isString(arguments[3])?b[arguments[3]]:arguments[3]}e=d[c];d[c]=function(){var c;c=e.apply(d,arguments);b||(b=this);a&&a.apply(b,arguments);return c};return{detach:function(){d[c]=e}}};d.defaultPlugins=[];l=function(a,b){var c,k,e;null==b&&(b={});b.allPlugins?e=b.allPlugins:(e=a.allPlugins||
[],b.plugins&&(e=e.concat(b.plugins)));e=_.clone(d.defaultPlugins).concat(e);a.setups=[];a.cleanups=[];k={};_.each(e,function(b){var c,d;for(c in b)h.call(b,c)&&(d=b[c],"setup"!==c&&("cleanup"!==c&&"staticProps"!==c)&&(k[c]=d));b.setup&&a.setups.push(b.setup);b.cleanup&&a.cleanups.push(b.cleanup)});for(c in k)h.call(k,c)&&(e=k[c],a[c]||(a[c]=e));for(c in b)h.call(b,c)&&(e=b[c],"plugins"!==c&&"initialize"!==c&&(a[c]=e))};p=function(a){_.each(a.setups,function(b){b.apply(a)})};m=function(a){_.each(a.cleanups,
function(b){b.apply(a)})};n=function(a,b){var c,d;c=Backbone.Model.extend.call(this,a,b);if(a){if(d=a.allPlugins)c.prototype.allPlugins=d;else if(d=a.plugins)c.prototype.allPlugins=c.prototype.allPlugins?c.prototype.allPlugins.concat(d):d;d&&_.each(d,function(a){a.staticProps&&_.extend(c,a.staticProps)})}c.prototype.plugins||(c.prototype.plugins=[]);return c};q=d.Class=function(){this.cid=_.uniqueId("obj");this.initialize.apply(this,arguments)};_.extend(q.prototype,Backbone.Events,{initialize:function(){var a;
a=0<arguments.length?arguments[arguments.length-1]:{};l(this,a);p(this);null!=a&&a.initialize&&a.initialize.apply(this,arguments)},destroy:function(){m(this)}});q.extend=n;d.Model=Backbone.Model.extend({initialize:function(a,b){l(this,b);p(this);null!=b&&b.initialize&&b.initialize.apply(this,arguments)},destroy:function(a){m(this);Backbone.Model.prototype.destroy.apply(this,arguments)}});d.Model.extend=n;d.Collection=Backbone.Collection.extend({initialize:function(a,b){l(this,b);p(this);null!=b&&
b.initialize&&b.initialize.apply(this,arguments)},destroy:function(){m(this)}});d.Collection.extend=n;d.View=Backbone.View.extend({initialize:function(a){l(this,a);p(this);null!=a&&a.initialize&&a.initialize.apply(this,arguments)},delegateEvents:function(a){var b,c,d,e,g,f=this;if(!a&&!(a=_.result(this,"events")))return this;this.undelegateEvents();b=function(a){return _.bind(function(b){return f[a](b)},f)};for(d in a)if(h.call(a,d)&&(g=a[d],this[g]&&_.isFunction(this[g])||_.isFunction(g)))if(e=d.match(/^(\S+)\s*(.*)$/),
c=e[1],e=e[2],g=_.isFunction(g)?g:b(g),c+=".delegateEvents"+this.cid,""===e)this.$el.on(c,g);else this.$el.on(c,e,g);return this},remove:function(){m(this);Backbone.View.prototype.remove.apply(this,arguments)},destroy:function(){this.remove()}});d.View.extend=n;d.AttachPlugin={setup:function(){this._attached=[]},attach:function(){var a;switch(arguments.length){case 2:a=d.attach(this,arguments[0],arguments[1]);break;case 3:a=d.attach(arguments[0],arguments[1],arguments[2])}this._attached.push(a);return a},
detach:function(a){var b,c;b=_.indexOf(this._attached,a);c=!1;-1!==b&&(this._attached.splice(b,1),a.detach(),c=!0);return c},cleanup:function(){_.invoke(this._attached,"detach");this._attached=[]}};d.defaultPlugins.push(d.AttachPlugin);d.ContainerPlugin={setup:function(){this.containerNode||(this.containerNode=this.$el);this.children||(this.children=[]);!1!==this.autoRender&&this.renderContainer()},renderContainer:function(){var a=this;_.each(this.children,function(b){a.addView(b)});return this},
getChild:function(a){return a&&a.cid?_.find(this.children,function(b){return b===a}):_.isNumber(a)?this.children[a]:_.isString(a)?_.find(this.children,function(b){return b.name===a}):null},addView:function(a,b){var c,d;d=null!=b?b.at:void 0;c=this.containerNode.find(">*");0<=d&&d<c.length?a.$el.insertBefore(c.eq(d)):this.containerNode.append(a.$el);return a},addChild:function(a,b){var c;c=null!=b?b.at:void 0;0<=c&&c<this.children.length?this.children.splice(c,0,a):this.children.push(a);return this.addView(a,
b)},removeChild:function(a,b){var c,d;d=_.isNumber(a)?a:_.indexOf(this.children,a);0<=d&&(c=this.children[d],c.remove(),this.children.splice(d,1),this.onChildRemoved(c));return c},onChildRemoved:function(a){},clearChildren:function(){var a,b;for(a=b=this.children.length-1;0<=b;a=b+=-1)this.removeChild(a,{silent:!0})},filterChildren:function(a){_.filter(this.children,function(b){b.model.filter(a)?b.$el.show():b.$el.hide()})},cleanup:function(){this.clearChildren()}};d.PublishPlugin={setup:function(){var a,
b,c;this._publishers=[];if(this.publishers)for(a in c=this.publishers,c)h.call(c,a)&&(b=c[a],this.addPublisher(a,b))},addPublisher:function(a,b){var c;c=d.attach(this,a,function(){var a;a=[].slice.call(arguments,0);a.unshift(b);Backbone.trigger.apply(Backbone,a)});this._publishers.push({handler:c,method:a,topic:b});return c},removePublisher:function(){var a,b,c,d,e;a=-1;e=this._publishers;for(b=d=e.length-1;0<=d;b=d+=-1)if(c=e[b],1<arguments.length&&_.isString(arguments[0])){if(arguments[0]===c.method&&
arguments[1]===c.topic){a=b;break}}else if(arguments[0]===c.handler){a=b;break}return 0<=a?(this._publishers[a].handler.detach(),this._publishers.splice(a,1),!0):!1},cleanup:function(){_.each(this._publishers,function(a){a.handler.detach()});this._publishers=[]}};d.defaultPlugins.push(d.PublishPlugin);d.Singleton={setup:function(){var a=this;if(_.find(d._singletons,function(b){return b.constructor===a.constructor}))throw Error("Only single instance can be initialized");d._singletons||(d._singletons=
[]);d._singletons.push(this)},staticProps:{getInstance:function(){var a,b=this;(a=_.find(d._singletons,function(a){return a.constructor===b}))||(a=new this);return a}}};d.SortablePlugin={setup:function(){!1!==this.sortable&&this.setSortable(!0)},_getSortableContainer:function(){return this.containerNode||this.$el},setSortable:function(a){var b,c=this;b=this._getSortableContainer();a?this._sortableInit?b.sortable("enable"):(a={start:function(a,b){b.item.startIndex=b.item.index()},stop:function(a,b){var d,
f,h,l;d=c.collection;f=d.at(b.item.startIndex);l=b.item.index();h=d.models;h.splice(b.item.startIndex,1);h.splice(l,0,f);d.reset(h);a.stopPropagation()}},this.sortableOptions&&(a=_.extend(a,this.sortableOptions)),b.sortable(a),this._sortableInit=!0):this._sortableInit&&b.sortable("disable")},cleanup:function(){this._sortableInit&&this._getSortableContainer().sortable("destroy")}};d.SubscribePlugin={setup:function(){var a,b,c;this._subscribers=[];if(this.subscribers)for(a in c=this.subscribers,c)h.call(c,
a)&&(b=c[a],this.addSubscriber(a,b))},addSubscriber:function(a,b){_.isString(b)&&(b=this[b]);this._subscribers.push({topic:a,callback:b});return Backbone.on(a,b,this)},removeSubscriber:function(a,b){var c,d,e,g,f;_.isString(b)&&(b=this[b]);c=-1;f=this._subscribers;for(d=g=f.length-1;0<=g;d=g+=-1)if(e=f[d],a===e.topic&&b===e.callback){c=d;break}return 0<=c?(-1!==c&&this._subscribers.splice(c,1),Backbone.off(a,b,this),!0):!1},cleanup:function(){var a=this;_.each(this._subscribers,function(b){return Backbone.off(b.topic,
b.callback,a)});this._subscribers=[]}};d.defaultPlugins.push(d.SubscribePlugin);d.TemplatePlugin={setup:function(){var a,b,c;if(this.model)this.model.on("change",this.renderTemplate,this);this.renderTemplate();if(this.templateNodes)for(a in c=this.templateNodes,c)h.call(c,a)&&(b=c[a],this[a]=this.$(b))},renderTemplate:function(){var a;a=this.template;_.isFunction(a)&&(a=a(this.model?this.model.attributes:this.options));this.$el.html(a)},cleanup:function(){this.model&&this.model.off("change",this.renderTemplate)}};
d.ActionView=d.View.extend({plugins:[d.TemplatePlugin],template:_.template('<%= leftActionHtml %><span class="main-cell"><%= text %></span><%= rightActionHtml %>'),templateNodes:{mainCell:".main-cell"},initialize:function(a){var b,c,k,e;this.$el.addClass("action-view");this.events||(this.events={});if(b=a.actions||this.actions)(k=b.left)&&(c=this._processActions(k,!0)),(b=_.isArray(b)?b:b.right)&&(e=this._processActions(b,!1));_.defaults(this.options,{leftActionHtml:c||"",rightActionHtml:e||"",text:""});
d.View.prototype.initialize.apply(this,arguments);this.delegateEvents(this.events);a.itemView&&(this.itemView=a.itemView);a.itemOptions&&(this.itemOptions=a.itemOptions)},_buttonTemplate:_.template('<<%- tagName %> class="<%- iconClass %>" title="<%- title %>"><%- text %></<%- tagName %>>'),_processActions:function(a,b){var c,d=this;c='<span class="'+(b?"left-cell":"right-cell")+'">';_.each(a,function(a){var b,f;b=a.iconClass;if(f=a.onClick)_.isString(f)&&(f=d[f]),f&&_.isFunction(f)&&(d.events["click ."+
b]=_.bind(f,d));a=_.defaults(a,{tagName:f?"button":"span",iconClass:"",title:"",text:""});c+=d._buttonTemplate(a)});return c+="</span>"},render:function(a){var b;this.itemView?(this.child||(b=this.child=new this.itemView(this.itemOptions),this.mainCell.append(b.$el)),b.render()):this.mainCell.text(a?a.text:"");return this},destroy:function(){this.itemView&&this.itemView.destroy&&this.child.destroy();d.View.prototype.destroy(this,arguments)}});d.StackView=d.View.extend({plugins:[d.ContainerPlugin],
effects:{HIDE_BACKWARD:["slide",{direction:"right"},"slow"],HIDE_FORWARD:["slide",{direction:"left"},"slow"],SHOW_BACKWARD:["slide",{direction:"left"},"slow"],SHOW_FORWARD:["slide",{direction:"right"},"slow"]},initialize:function(a){var b,c=this;null==a&&(a={});d.View.prototype.initialize.apply(this,arguments);this.$el.css({position:"relative",width:"100%"});this.attach("addView",function(a,b){!0===(null!=b?b.showOnAdd:void 0)&&c.showChild(a,!0)});b=a.showIndex||0;this.children&&(0<=b&&b<this.children.length)&&
(this._previousView=this._currentView=this.children[b]);this.render()},render:function(){this.showChild(this._currentView,!0);return this},addView:function(a,b){var c,k=this;a.$el.css({position:"absolute",width:"99%"});d.ContainerPlugin.addView.apply(this,arguments);if(c=this.navigationEvents)if(c=c[a.name])c=_.isArray(c)?c:[c],_.each(c,function(b){k.attachNavigationEvent(a,b)});a.$el.hide()},addChild:function(a,b){0===this.children.length&&(b||(b={}),b.showOnAdd=!0);return d.ContainerPlugin.addChild.apply(this,
[a,b])},removeChild:function(a){var b,c;a=this.getChild(a);a===this._currentView&&(c=_.indexOf(this.children,a),1<this.children.length?0<c?b=this.getChild(c-1,!0):0===c&&(b=this.getChild(1,!0)):b=null,this.showChild(b,!0));return d.ContainerPlugin.removeChild.apply(this,arguments)},attachNavigationEvent:function(a,b){var c,d=this;!0===b.back?a.attach(a,b.event,function(){d.onBack()}):b.target&&(c=_.find(this.children,function(a){return a.name===b.target}),a.attach(a,b.event,function(){d.showChild(c)}))},
onBack:function(){this.showPreviousChild()},showChild:function(a,b){var c,d,e;a=this.getChild(a);c=_.indexOf(this.children,a)<_.indexOf(this.children,this._currentView);this._currentView&&(b||(d=this.effects[c?"HIDE_BACKWARD":"HIDE_FORWARD"]),this._currentView.$el.hide.apply(this._currentView.$el,d));a&&(b||(e=this.effects[c?"SHOW_BACKWARD":"SHOW_FORWARD"]),a.$el.show.apply(a.$el,e));this._previousView=this._currentView;return this._currentView=a},showPreviousChild:function(){this._previousView&&
this.showChild(this._previousView)}});d.ListView=d.View.extend({plugins:[d.TemplatePlugin,d.ContainerPlugin],messages:{NO_ITEMS:"No Items"},template:'<div class="main-node"><div class="container-node"></div><div class="message-node"></div></div><div class="loading-node">Loading...</div>',templateNodes:{containerNode:".container-node",messageNode:".message-node",mainNode:".main-node",loadingNode:".loading-node"},itemView:d.View,initialize:function(a){var b,c=this;this.$el.addClass("list-view");a.itemView&&
(this.itemView=a.itemView);d.View.prototype.initialize.apply(this,arguments);this.setLoading(!1);b=this.collection;b.on("reset",this.render,this);b._onAddModel=function(a,b,d){c.renderModel(a,d)};b.on("add",b._onAddModel);this.render()},render:function(){var a=this;this.toggleContainerNode(0<this.collection.models.length,this.messages.NO_ITEMS);this.clearChildren();_.each(this.collection.models,function(b){a.renderModel(b,{silent:!0})});return this},toggleContainerNode:function(a,b){var c,d;d=this.messageNode;
c=this.containerNode;a?(d.hide(),c.show()):(d.html(b),d.show(),c.hide())},renderModel:function(a,b){var c,d=this;c=this.createChild(a);a._onModelDestroy=function(){d.removeChild(c);a.off("destroy")};a.on("destroy",a._onModelDestroy);this.addChild(c,b);null!=b&&b.silent||this.toggleContainerNode(0<this.collection.models.length,this.messages.NO_ITEMS);return c},createChild:function(a){return(new this.itemView(_.extend(this.itemOptions||{},{model:a}))).render()},removeChild:function(a,b){var c=this;
a=this.getChild(a);!0===(null!=b?b.silent:void 0)?d.ContainerPlugin.removeChild.call(this,a):a.$el.hide("slide",{direction:"left"},"fast",function(){d.ContainerPlugin.removeChild.call(c,a);c.toggleContainerNode(0<c.collection.models.length,c.messages.NO_ITEMS)});return a},clearChildren:function(){_.each(this.collection.models,function(a){a._onModelDestroy&&a.off("destroy",a._onModelDestroy)});d.ContainerPlugin.clearChildren.apply(this,arguments)},setLoading:function(a){a?(this.loadingNode.show(),
this.mainNode.hide()):(this.loadingNode.hide(),this.mainNode.show())},destroy:function(){var a;this.clearChildren();a=this.collection;a.off("reset",this.render);a.off("add",a._onAddModel);d.View.prototype.destroy.apply(this,arguments)}});r=d.ActionView.extend({actions:{left:[{iconClass:"delete-icon",title:"Confirm delete",onClick:"onRemoveConfirmButtonClick"}],right:[{iconClass:"reorder-handle",title:"Reorder"},{iconClass:"delete-button",title:"Delete",text:"Delete",onClick:"onRemoveButtonClick"}]},
onRemoveConfirmButtonClick:function(a){var b;b=this.$el.hasClass("remove-confirm");this.$el.toggleClass("remove-confirm",!b);a.stopPropagation()},onRemoveButtonClick:function(a){this.child.model.destroy();a.stopPropagation()}});d.EditableListView=d.ListView.extend({plugins:[d.SortablePlugin],sortableOptions:{handle:".reorder-handle"},initialize:function(a){this.$el.addClass("editable-list-view");d.ListView.prototype.initialize.apply(this,arguments);this.setEditable(!0===a.editable||!1)},setEditable:function(a){this.setSortable(a);
this.containerNode.toggleClass("listview-edit",a)},createChild:function(a){return(new r({itemView:this.itemView,itemOptions:_.extend(this.itemOptions||{},{model:a})})).render()}});d.TabButtonView=d.View.extend({tagName:"a",attributes:{href:"#","class":"tab-button"},plugins:[d.TemplatePlugin],template:_.template("<%- text %>")});d.TabView=d.StackView.extend({allPlugins:[d.TemplatePlugin,d.ContainerPlugin],template:'<div class="tab-button-container"></div><div class="tab-content-container"></div>',
templateNodes:{containerNode:".tab-content-container"},autoRender:!1,render:function(){this._buttonMap={};this.buttonContainer=new d.View({el:".tab-button-container",plugins:[d.ContainerPlugin]});this.renderContainer();d.StackView.prototype.render.apply(this,arguments);return this},addView:function(a,b){var c;d.StackView.prototype.addView.apply(this,arguments);b={text:a.title||a.name,tabView:this,onClick:function(){this.tabView.showChild(this._tabContentView)}};_.extend(b,this.tabButtonOptions);b.events||
(b.events={});b.events.click="onClick";c=new (this.tabButtonView||d.TabButtonView)(b);this.buttonContainer.addChild(c);this._buttonMap[a.cid]=c;c._tabContentView=a},removeChild:function(a){var b,c;if(b=d.StackView.prototype.removeChild.apply(this,arguments))c=this._buttonMap[b.cid],this.buttonContainer.removeChild(c),delete this._buttonMap[b.cid];return b},showChild:function(a){var b;if(a=d.StackView.prototype.showChild.apply(this,[a,!0]))b=this._buttonMap,this._previousView&&b[this._previousView.cid].$el.removeClass("selected"),
b[a.cid].$el.addClass("selected");return a},getTabContent:function(a){return a._tabContentView}});d.CloseTabButtonPlugin={tabButtonView:d.ActionView,tabButtonOptions:{attributes:{"class":"tab-button"},actions:[{iconClass:"tab-close",onClick:function(a){var b;b=this.tabView.getTabContent(this);this.tabView.removeChild(b);a.stopPropagation()}}]}};d.GoogleMapView=d.View.extend({apiKey:"",defaultLocation:{lat:-34.397,lng:150.644},subscribers:{GOOGLE_MAP_SCRIPT_LOADED:"_onScriptLoaded"},initialize:function(a){d.View.prototype.initialize.apply(this,
arguments);a.el||this.$el.css({width:"100%",height:"100%"})},initMap:function(){var a;if(!this.apiKey||0===this.apiKey.length)throw Error("You need Google Map API key to use this widget");this._mapInit||(a=document.createElement("script"),a.type="text/javascript",a.src="http://maps.googleapis.com/maps/api/js?sensor=true&callback=Backpack.GoogleMapView.onScriptLoaded&key="+this.apiKey,document.body.appendChild(a),this._mapInit=!0)},_onScriptLoaded:function(){this.map=new google.maps.Map(this.$el.get(0),
{zoom:8,center:new google.maps.LatLng(this.defaultLocation.lat,this.defaultLocation.lng),mapTypeId:google.maps.MapTypeId.ROADMAP});this.removeSubscriber("GOOGLE_MAP_SCRIPT_LOADED",this._onScriptLoaded)},setLocation:function(a){this.map.panTo(new google.maps.LatLng(a.lat,a.lng))},addMarker:function(a){(new google.maps.Marker({position:new google.maps.LatLng(a.lat,a.lng),title:a.title})).setMap(this.map)}});d.GoogleMapView.onScriptLoaded=function(){Backbone.trigger("GOOGLE_MAP_SCRIPT_LOADED")}}).call(this);
